{"version":3,"file":"Intersection.mjs","sourceRoot":"","sources":["Intersection.ts"],"names":[],"mappings":"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","sourcesContent":["import WeakMap from '../../shim/WeakMap';\nimport Map from '../../shim/Map';\nimport { Base } from './Base';\nimport IntersectionObserver from '../../shim/IntersectionObserver';\n\nexport interface ExtendedIntersectionObserverEntry extends IntersectionObserverEntry {\n\treadonly isIntersecting: boolean;\n}\n\nexport interface IntersectionDetail extends IntersectionGetOptions {\n\tentries: WeakMap<Element, IntersectionResult>;\n\tobserver: IntersectionObserver;\n}\n\nexport interface IntersectionGetOptions {\n\troot?: string;\n\trootMargin?: string;\n\tthreshold?: number[];\n}\n\nexport interface IntersectionResult {\n\tintersectionRatio: number;\n\tisIntersecting: boolean;\n}\n\nconst defaultIntersection: IntersectionResult = Object.freeze({\n\tintersectionRatio: 0,\n\tisIntersecting: false\n});\n\nexport class Intersection extends Base {\n\tprivate readonly _details = new Map<string, IntersectionDetail>();\n\n\t/**\n\t * Return an `InteractionResult` for the requested key and options.\n\t *\n\t * @param key The key to return the intersection meta for\n\t * @param options The options for the request\n\t */\n\tpublic get(key: string | number, options: IntersectionGetOptions = {}): IntersectionResult {\n\t\tlet rootNode: HTMLElement | undefined;\n\t\tif (options.root) {\n\t\t\trootNode = this.getNode(options.root) as HTMLElement;\n\t\t\tif (!rootNode) {\n\t\t\t\treturn defaultIntersection;\n\t\t\t}\n\t\t}\n\t\tconst node = this.getNode(key);\n\t\tif (!node) {\n\t\t\treturn defaultIntersection;\n\t\t}\n\n\t\tlet details = this._getDetails(options) || this._createDetails(options, rootNode);\n\t\tif (!details.entries.get(node)) {\n\t\t\tdetails.entries.set(node, defaultIntersection);\n\t\t\tdetails.observer.observe(node);\n\t\t}\n\n\t\treturn details.entries.get(node) || defaultIntersection;\n\t}\n\n\t/**\n\t * Returns true if the node for the key has intersection details\n\t *\n\t * @param key The key to return the intersection meta for\n\t * @param options The options for the request\n\t */\n\tpublic has(key: string | number, options?: IntersectionGetOptions): boolean {\n\t\tconst node = this.getNode(key);\n\t\tconst details = this._getDetails(options);\n\t\treturn Boolean(details && node && details.entries.has(node));\n\t}\n\n\tprivate _createDetails(options: IntersectionGetOptions, rootNode?: HTMLElement): IntersectionDetail {\n\t\tconst entries = new WeakMap<HTMLElement, ExtendedIntersectionObserverEntry>();\n\t\tconst observer = new IntersectionObserver(this._onIntersect(entries), { ...options, root: rootNode });\n\t\tconst details = { observer, entries, ...options };\n\n\t\tthis._details.set(JSON.stringify(options), details);\n\t\tthis.own({\n\t\t\tdestroy: () => observer.disconnect()\n\t\t});\n\t\treturn details;\n\t}\n\n\tprivate _getDetails(options: IntersectionGetOptions = {}): IntersectionDetail | undefined {\n\t\treturn this._details.get(JSON.stringify(options));\n\t}\n\n\tprivate _onIntersect = (detailEntries: WeakMap<Element, IntersectionResult>) => {\n\t\treturn (entries: ExtendedIntersectionObserverEntry[]) => {\n\t\t\tfor (const { intersectionRatio, isIntersecting, target } of entries) {\n\t\t\t\tdetailEntries.set(target, { intersectionRatio, isIntersecting });\n\t\t\t}\n\t\t\tthis.invalidate();\n\t\t};\n\t};\n}\n\nexport default Intersection;\n"]}