{"version":3,"file":"block.js","sourceRoot":"","sources":["block.ts"],"names":[],"mappings":";;;;;;;;;;IAAA,iBA0BA;;;IA1BA,gCAAwC;IACxC,iCAA4B;IAC5B,mCAA8B;IAE9B,IAAM,YAAY,GAAG,aAAM,CAAC,EAAE,KAAK,cAAA,EAAE,KAAK,iBAAA,EAAE,MAAM,kBAAA,EAAE,CAAC,CAAC;IAEzC,QAAA,KAAK,GAAG,YAAY,CAAC,UAAC,EAAwC;YAAtC,kBAAoC,EAAtB,gBAAK,EAAE,kBAAM,EAAE,gBAAK;QACtE,IAAI,EAAE,GAAG,CAAC,CAAC;QACX,OAAO,UAAoC,MAAS;YACnD,OAAO;gBAAC,cAAsB;qBAAtB,UAAsB,EAAtB,qBAAsB,EAAtB,IAAsB;oBAAtB,yBAAsB;;gBAC7B,IAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;gBACxC,IAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC;gBAC3C,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;gBAC5B,IAAM,WAAW,GAAG,MAAM,CAAC,QAAQ,CAAI,QAAQ,SAAI,UAAY,EAAE;;;;;gCAC1D,GAAG,GAAG,MAAM,gCAAI,IAAI,EAAC,CAAC;gCAC5B,KAAK,CAAC,KAAK,EAAE,CAAC;gCACC,qBAAM,GAAG,EAAA;;gCAAlB,MAAM,GAAG,SAAS;gCACxB,KAAK,CAAC,MAAM,EAAE,CAAC;gCACf,sBAAO,MAAM,EAAC;;;qBACd,CAAC,CAAC;gBACH,OAAO,WAAW,IAAI,IAAI,CAAC;YAC5B,CAAC,CAAC;QACH,CAAC,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,kBAAe,aAAK,CAAC","sourcesContent":["import { create, defer } from '../vdom';\nimport cache from './cache';\nimport icache from './icache';\n\nconst blockFactory = create({ defer, cache, icache });\n\nexport const block = blockFactory(({ middleware: { cache, icache, defer } }) => {\n\tlet id = 1;\n\treturn <T extends (...args: any[]) => any>(module: T) => {\n\t\treturn (...args: Parameters<T>): (ReturnType<T> extends Promise<infer U> ? U : ReturnType<T>) | null => {\n\t\t\tconst argsString = JSON.stringify(args);\n\t\t\tconst moduleId = cache.get(module) || id++;\n\t\t\tcache.set(module, moduleId);\n\t\t\tconst cachedValue = icache.getOrSet(`${moduleId}-${argsString}`, async () => {\n\t\t\t\tconst run = module(...args);\n\t\t\t\tdefer.pause();\n\t\t\t\tconst result = await run;\n\t\t\t\tdefer.resume();\n\t\t\t\treturn result;\n\t\t\t});\n\t\t\treturn cachedValue || null;\n\t\t};\n\t};\n});\n\nexport default block;\n"]}