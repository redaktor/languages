{"version":3,"file":"StoreProvider.js","sourceRoot":"","sources":["StoreProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import WidgetBase from '../core/WidgetBase';\nimport { DNode } from '../core/interfaces';\nimport { Store, StatePaths, Path } from './Store';\nimport { diffProperty } from '../core/decorators/diffProperty';\nimport { Handle } from '../core/Destroyable';\nimport { shallow } from '../core/diff';\nimport { alwaysRender } from '../core/decorators/alwaysRender';\n\nexport interface GetPaths<S = any> {\n\t(path: StatePaths<S>): Path<S, any>[];\n}\n\nexport interface StoreProviderProperties<S = any> {\n\trenderer: (store: Store<S>) => DNode | DNode[];\n\tstateKey?: string;\n\tpaths?: GetPaths<S>;\n}\n\nfunction mockPath(...paths: string[]): string {\n\treturn paths.join(',');\n}\n\nfunction pathDiff(previousProperty: Function, newProperty: Function) {\n\tconst previousPaths = previousProperty ? previousProperty(mockPath) : [];\n\tconst currentPaths = newProperty ? newProperty(mockPath) : [];\n\tconst result = shallow(previousPaths, currentPaths);\n\treturn {\n\t\tchanged: result.changed,\n\t\tvalue: newProperty\n\t};\n}\n\n@alwaysRender()\nexport class StoreProvider<S = any> extends WidgetBase<StoreProviderProperties<S>, never> {\n\tprivate _handle: Handle | undefined;\n\n\tprivate _getStore(key: string): Store<S> | undefined {\n\t\tconst item = this.registry.getInjector<Store<S>>(key);\n\t\tif (item) {\n\t\t\treturn item.injector();\n\t\t}\n\t}\n\n\tprivate _getProperties() {\n\t\treturn { stateKey: 'state', ...this.properties };\n\t}\n\n\t@diffProperty('stateKey')\n\t@diffProperty('paths', pathDiff)\n\tprotected onChange(previousProperties: any, currentProperties: StoreProviderProperties) {\n\t\tconst { stateKey = 'state', paths } = currentProperties;\n\t\tif (this._handle) {\n\t\t\tthis._handle.destroy();\n\t\t\tthis._handle = undefined;\n\t\t}\n\t\tconst store = this._getStore(stateKey);\n\t\tif (store) {\n\t\t\tif (paths) {\n\t\t\t\tconst handle = store.onChange(paths(store.path), () => this.invalidate());\n\t\t\t\tthis._handle = {\n\t\t\t\t\tdestroy: () => {\n\t\t\t\t\t\thandle.remove();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tthis._handle = store.on('invalidate', () => {\n\t\t\t\t\tthis.invalidate();\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.own(this._handle);\n\t\t}\n\t}\n\n\tprotected render(): DNode | DNode[] {\n\t\tconst { stateKey, renderer } = this._getProperties();\n\t\tconst store = this._getStore(stateKey);\n\t\tif (!this._handle) {\n\t\t\tthis.onChange({}, this._getProperties());\n\t\t}\n\t\tif (store) {\n\t\t\treturn renderer(store);\n\t\t}\n\t}\n}\n\nexport default StoreProvider;\n"]}